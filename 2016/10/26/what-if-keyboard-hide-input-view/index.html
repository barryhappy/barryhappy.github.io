<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Androidçˆ¬å‘ä¹‹æ—…ï¼šè½¯é”®ç›˜æŒ¡ä½è¾“å…¥æ¡†é—®é¢˜çš„ç»ˆæè§£å†³æ–¹æ¡ˆ Â· Barry's Blog</title><meta name="description" content="Androidçˆ¬å‘ä¹‹æ—…ï¼šè½¯é”®ç›˜æŒ¡ä½è¾“å…¥æ¡†é—®é¢˜çš„ç»ˆæè§£å†³æ–¹æ¡ˆ - Barry Zhang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="https://avatars0.githubusercontent.com/u/5143676?v=3&amp;s=466"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://barryhappy.github.io/atom.xml" title="Barry's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="https://avatars0.githubusercontent.com/u/5143676?v=3&amp;s=466"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/barryhappy" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="http://www.barryzhang.com/" target="_blank" class="nav-list-link">BARRYZHANG</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Androidçˆ¬å‘ä¹‹æ—…ï¼šè½¯é”®ç›˜æŒ¡ä½è¾“å…¥æ¡†é—®é¢˜çš„ç»ˆæè§£å†³æ–¹æ¡ˆ</h1><div class="post-info">2016å¹´10æœˆ26æ—¥</div><div class="post-content"><blockquote>
<p>æœ¬æ–‡ç”±<a href="https://github.com/barryhappy" target="_blank" rel="external">BarryZhang</a>åŸåˆ›ï¼ŒåŒæ—¶é¦–å‘äºdiycode.ccã€barryzhang.com ã€github.com/barryhappyï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜ä½œè€…å’ŒåŸæ–‡é“¾æ¥ã€‚</p>
</blockquote>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å¼€å‘åšå¾—ä¹…äº†ï¼Œæ€»å…ä¸äº†ä¼šé‡åˆ°å„ç§å‘ã€‚<br>è€Œåœ¨Androidå¼€å‘çš„è·¯ä¸Šï¼Œã€è½¯é”®ç›˜æŒ¡ä½äº†è¾“å…¥æ¡†ã€è¿™ä¸ªå‘ï¼Œå¯è°“æ˜¯ä¸€ä¸ªæ—·æ—¥æŒä¹…çš„å·¨å‘â€”â€”æ¥æ¥æ¥ï¼Œæˆ‘ä»¬æ…¢æ…¢çœ‹ã€‚</p>
<a id="more"></a> 
<h1 id="å…¥é—¨ç¯‡"><a href="#å…¥é—¨ç¯‡" class="headerlink" title="å…¥é—¨ç¯‡"></a>å…¥é—¨ç¯‡</h1><p><img src="http://barryzhang.qiniudn.com/QQ20161024-0.png" alt="Base"></p>
<p>æœ€åŸºæœ¬çš„æƒ…å†µï¼Œå¦‚å›¾æ‰€ç¤ºï¼šåœ¨é¡µé¢åº•éƒ¨æœ‰ä¸€ä¸ªEditTextï¼Œå¦‚æœä¸åšä»»ä½•å¤„ç†ï¼Œé‚£ä¹ˆåœ¨è½¯é”®ç›˜å¼¹å‡ºçš„æ—¶å€™ï¼Œå°±æœ‰å¯èƒ½ä¼šæŒ¡ä½EditTextã€‚<br>å¯¹äºè¿™ç§æƒ…å†µçš„å¤„ç†å…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨AndroidManifestæ–‡ä»¶ä¸­å¯¹activityè®¾ç½®ï¼š<code>android:windowSoftInputMode</code>çš„å€¼<code>adjustPan</code>æˆ–è€…<code>adjustResize</code>å³å¯ï¼Œåƒè¿™æ ·ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">activity</span></span></div><div class="line">	<span class="attr">android:name</span>=<span class="string">".MainActivity"</span></div><div class="line">	<span class="attr">android:windowSoftInputMode</span>=<span class="string">"adjustPan"</span>  &gt;</div><div class="line">    ...</div><div class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div></pre></td></tr></table></figure>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä»–ä»¬éƒ½å¯ä»¥è§£å†³é—®é¢˜ï¼Œå½“ç„¶ï¼Œ<code>adjustPan</code>è·Ÿ<code>adjustResize</code>çš„æ•ˆæœç•¥æœ‰åŒºåˆ«ã€‚ </p>
<ul>
<li><code>adjustPan</code>æ˜¯æŠŠæ•´ä¸ªç•Œé¢å‘ä¸Šå¹³ç§»ï¼Œä½¿è¾“å…¥æ¡†éœ²å‡ºï¼Œä¸ä¼šæ”¹å˜ç•Œé¢çš„å¸ƒå±€ï¼›</li>
<li><code>adjustResize</code>åˆ™æ˜¯é‡æ–°è®¡ç®—å¼¹å‡ºè½¯é”®ç›˜ä¹‹åçš„ç•Œé¢å¤§å°ï¼Œç›¸å½“äºæ˜¯ç”¨æ›´å°‘çš„ç•Œé¢åŒºåŸŸå»æ˜¾ç¤ºå†…å®¹ï¼Œè¾“å…¥æ¡†ä¸€èˆ¬è‡ªç„¶ä¹Ÿå°±åœ¨å†…äº†ã€‚</li>
</ul>
<p>â†‘â†‘â†‘ OKï¼Œè¿™åªæ˜¯å…¥é—¨ï¼ŒåŸºæœ¬ä¸Šåœ°çƒä¸Šæ‰€æœ‰çš„Androidå·¥ç¨‹å¸ˆéƒ½èƒ½æå®šã€‚<br>åˆ«æ€¥ï¼Œçœ‹ä¸‹é¢~</p>
<h1 id="åŠ ä¸ŠWebViewè¯•è¯•çœ‹ï¼Ÿå‘æ¥äº†â€¦â€¦"><a href="#åŠ ä¸ŠWebViewè¯•è¯•çœ‹ï¼Ÿå‘æ¥äº†â€¦â€¦" class="headerlink" title="åŠ ä¸ŠWebViewè¯•è¯•çœ‹ï¼Ÿå‘æ¥äº†â€¦â€¦"></a>åŠ ä¸ŠWebViewè¯•è¯•çœ‹ï¼Ÿå‘æ¥äº†â€¦â€¦</h1><h2 id="æƒ…å†µæè¿°"><a href="#æƒ…å†µæè¿°" class="headerlink" title="æƒ…å†µæè¿°"></a>æƒ…å†µæè¿°</h2><p>ä¸Šé¢çš„å…¥é—¨ç¯‡ä¸­ï¼Œè½¯é”®ç›˜æ˜¯ç”±åŸç”Ÿçš„EditTextè§¦å‘å¼¹å‡ºçš„ã€‚è€Œåœ¨H5ã€Hybridå‡ ä¹å·²ç»æˆä¸ºAppæ ‡é…çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸è¿˜ä¼šç¢°åˆ°çš„æƒ…å†µæ˜¯ï¼š<strong>è½¯é”®ç›˜æ˜¯ç”±WebViewä¸­çš„ç½‘é¡µå…ƒç´ æ‰€è§¦å‘å¼¹å‡ºçš„</strong>ã€‚  </p>
<p>è¿™æ—¶å€™ï¼Œæƒ…å†µå°±ä¼šå˜å¾—å¤æ‚äº†: </p>
<ol>
<li>é¦–å…ˆï¼Œé¡µé¢æ˜¯<code>éå…¨å±æ¨¡å¼</code>çš„æƒ…å†µä¸‹ï¼Œç»™activityè®¾ç½®<code>adjustPan</code>ä¼šå¤±æ•ˆã€‚</li>
<li>å…¶æ¬¡ï¼Œé¡µé¢æ˜¯<code>å…¨å±æ¨¡å¼</code>çš„æƒ…å†µï¼Œ<code>adjustPan</code>è·Ÿ<code>adjustResize</code>éƒ½ä¼šå¤±æ•ˆã€‚</li>
</ol>
<p>â€”â€”è§£é‡Šä¸€ä¸‹ï¼Œè¿™é‡Œçš„<code>å…¨å±æ¨¡å¼</code>å³æ˜¯é¡µé¢æ˜¯å…¨å±çš„ï¼ŒåŒ…æ‹¬Applicationæˆ–activityä½¿ç”¨äº†Fullscreenä¸»é¢˜ã€ä½¿ç”¨äº†ã€çŠ¶æ€è‰²ç€è‰²ã€ã€ã€æ²‰æµ¸å¼çŠ¶æ€æ ã€ã€ã€Immersive Modeã€ç­‰ç­‰â€”â€”æ€»ä¹‹ï¼ŒåŸºæœ¬ä¸Šåªè¦æ˜¯Appè‡ªå·±æ¥ç®¡äº†çŠ¶æ€æ çš„æ§åˆ¶ï¼Œå°±ä¼šäº§ç”Ÿè¿™ç§é—®é¢˜ã€‚ </p>
<p>ä¸‹é¢è¿™ä¸ªè¡¨æ ¼å¯ä»¥ç®€å•åˆ—ä¸¾äº†å…·ä½“çš„æƒ…å†µã€‚ </p>
<p><img src="http://barryzhang.qiniudn.com/14773156950939.jpg" alt="è¡¨æ ¼"></p>
<h2 id="ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸ªå‘ï¼Ÿâ€issue-5497â€"><a href="#ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸ªå‘ï¼Ÿâ€issue-5497â€" class="headerlink" title="ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸ªå‘ï¼Ÿâ€issue 5497â€"></a>ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸ªå‘ï¼Ÿâ€issue 5497â€</h2><p>ä¸Šé¢è¡¨æ ¼çš„è¿™ç§æƒ…å†µå¹¶éæ˜¯Googleæ‰€æœŸæœ›çš„ï¼Œç†æƒ³çš„æƒ…å†µå½“ç„¶æ˜¯å®ƒä»¬éƒ½èƒ½æ­£å¸¸ç”Ÿæ•ˆæ‰å¯¹â€”â€”æ‰€ä»¥è¿™å…¶å®æ˜¯Androidç³»ç»Ÿæœ¬èº«çš„ä¸€ä¸ªBUGã€‚ </p>
<p>ä¸ºä»€ä¹ˆæ–‡ç« å¼€å¤´è¯´è¿™æ˜¯ä¸ªå‘å‘¢ï¼Ÿ<br>â€”â€”å› ä¸ºè¿™ä¸ªBUGä»Android1.xæ—¶ä»£ï¼ˆ2009å¹´ï¼‰å°±è¢«æŠ¥å‘Šäº†ï¼Œè€Œä¸€ç›´åˆ°äº†å¦‚ä»Šçš„Android7.0ï¼ˆ2016å¹´ï¼‰è¿˜æ˜¯æ²¡æœ‰ä¿®å¤â€¦â€¦/(ã„’oã„’)/<br>å¯ä»¥è¯´è¿™ä¸ä»…æ˜¯ä¸ªå‘ï¼Œè€Œä¸”è¿˜æ˜¯ä¸ªå®˜æ–¹æŒ–çš„å‘~</p>
<p>â€œissue 5497â€ï¼Œè¯¦æƒ…ä¼ é€é—¨ â˜ <a href="https://code.google.com/p/android/issues/detail?id=5497" target="_blank" rel="external">Issue 5497 - android -WebView adjustResize windowSoftInputMode breaks when activity is fullscreen - Android Open Source Project - Issue Tracker - Google Project Hosting</a></p>
<p>å½“ç„¶äº†ï¼Œä¸ç®¡å‘æ˜¯è°æŒ–çš„ï¼Œæœ€ç»ˆè¿˜æ˜¯è¦å¼€å‘è€…æ¥è§£å†³ã€‚</p>
<p>é‡åˆ°å‘ä¹‹åï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è¿‡å»ï¼šèº²ï¼Œæˆ–è€…å¡«ã€‚</p>
<h1 id="èº²å‘å§¿åŠ¿"><a href="#èº²å‘å§¿åŠ¿" class="headerlink" title="èº²å‘å§¿åŠ¿"></a>èº²å‘å§¿åŠ¿</h1><p>å¦‚å‰æ–‡æ‰€ç¤ºï¼Œå‡ºç°å‘çš„æ¡ä»¶æ˜¯ï¼šå¸¦æœ‰WebViewçš„activityä½¿ç”¨äº†<code>å…¨å±æ¨¡å¼</code>æˆ–è€…<code>adjustPan</code>æ¨¡å¼ã€‚<br>é‚£ä¹ˆèº²å‘çš„å§¿åŠ¿å°±å¾ˆç®€å•äº†â€”â€”<br>    <strong>å¦‚æœactivityä¸­æœ‰WebViewï¼Œå°±ä¸è¦ä½¿ç”¨<code>å…¨å±æ¨¡å¼</code>ï¼Œå¹¶ä¸”æŠŠå®ƒçš„windowSoftInputModeå€¼è®¾ä¸º<code>adjustResize</code>å°±å¥½äº†å˜›</strong></p>
<p>æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼ŸğŸ˜‘<br><img src="http://barryzhang.qiniudn.com/20130927092846557.jpg" alt="20130927092846557"></p>
<h1 id="å¡«å‘å§¿åŠ¿"><a href="#å¡«å‘å§¿åŠ¿" class="headerlink" title="å¡«å‘å§¿åŠ¿"></a>å¡«å‘å§¿åŠ¿</h1><p>ä½†æ€»æœ‰äº›æ—¶å€™ï¼Œæ˜¯éœ€è¦<code>å…¨å±æ¨¡å¼</code>è·ŸWebViewå…¼å¾—çš„ï¼Œè¿™æ—¶å€™ï¼Œèº²å‘å°±ä¸è¡Œäº†ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„å¡«å‘çš„å§¿åŠ¿ã€‚å¹¸å¥½ï¼Œå¼€å‘è€…çš„æ™ºæ…§æ˜¯æ— ç©·çš„ï¼Œè¿™ä¸ªå‘å‡ºç°äº†è¿™ä¹ˆå¤šå¹´ï¼Œè¿˜æ˜¯æœ‰äººæ‰¾åˆ°äº†ä¸€äº›è§£å†³æ–¹æ¡ˆçš„ã€‚ </p>
<h2 id="AndroidBug5497Workaround"><a href="#AndroidBug5497Workaround" class="headerlink" title="AndroidBug5497Workaround"></a>AndroidBug5497Workaround</h2><p>æˆ‘ä¸ªäººè®¤ä¸ºæœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯è¿™ä¸ªï¼š<a href="http://stackoverflow.com/a/19494006" target="_blank" rel="external">AndroidBug5497Workaround</a>ï¼Œåªéœ€è¦ä¸€ä¸ªç¥å¥‡çš„<code>AndroidBug5497Workaround</code>ç±»ã€‚</p>
<p>ä½¿ç”¨æ­¥éª¤ï¼š</p>
<ol>
<li>æŠŠ<code>AndroidBug5497Workaround</code>ç±»å¤åˆ¶åˆ°é¡¹ç›®ä¸­</li>
<li>åœ¨éœ€è¦å¡«å‘çš„activityçš„onCreateæ–¹æ³•ä¸­æ·»åŠ ä¸€å¥<code>AndroidBug5497Workaround.assistActivity(this)</code>å³å¯ã€‚  </li>
</ol>
<p>ç»è¿‡æµ‹è¯•ï¼ŒåŸºæœ¬åœ¨å„ä¸ªAndroidç‰ˆæœ¬ä¸Šéƒ½å¯ç”¨ï¼Œæ•ˆæœåŸºæœ¬ä¸è®¾ç½®äº†<code>adjustResize</code>ç›¸å½“ã€‚<br>çœ‹ä¸€ä¸ªå¯¹æ¯”å›¾ï¼š<br><img src="http://barryzhang.qiniudn.com/webview-compare.jpg" alt="æ•ˆæœå¯¹æ¯”å›¾"></p>
<p>æ¥è‡ªæˆ‘å‚Appçš„æŸä¸ªä½¿ç”¨WebViewçš„<code>å…¨å±æ¨¡å¼</code>Activityé¡µé¢ï¼Œä»å·¦åˆ°å³åˆ†åˆ«æ˜¯ï¼šæ²¡æœ‰è½¯é”®ç›˜çš„æ ·å¼ã€è½¯é”®ç›˜æŒ¡ä½è¾“å…¥æ¡†çš„æ•ˆæœã€ä»¥åŠä½¿ç”¨AndroidBug5497Workaroundä¹‹åçš„æœ€ç»ˆæ•ˆæœã€‚</p>
<h2 id="å®ƒçš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#å®ƒçš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="å®ƒçš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"></a>å®ƒçš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>è¿™ä¸ªç‚«é…·AndroidBug5497Workaroundç±»ï¼Œå…¶å®å¹¶ä¸æ˜¯å¾ˆå¤æ‚ï¼Œåªæœ‰å‡ åè¡Œä»£ç ï¼Œå…ˆè´´åœ¨è¿™é‡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AndroidBug5497Workaround</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// For more information, see https://code.google.com/p/android/issues/detail?id=5497</span></div><div class="line">    <span class="comment">// To use this class, simply invoke assistActivity() on an Activity that already has its content view set.</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">assistActivity</span> <span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> AndroidBug5497Workaround(activity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> View mChildOfContent;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> usableHeightPrevious;</div><div class="line">    <span class="keyword">private</span> FrameLayout.LayoutParams frameLayoutParams;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AndroidBug5497Workaround</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line">        FrameLayout content = (FrameLayout) activity.findViewById(android.R.id.content);</div><div class="line">        mChildOfContent = content.getChildAt(<span class="number">0</span>);</div><div class="line">        mChildOfContent.getViewTreeObserver().addOnGlobalLayoutListener(<span class="keyword">new</span> ViewTreeObserver.OnGlobalLayoutListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onGlobalLayout</span><span class="params">()</span> </span>&#123;</div><div class="line">                possiblyResizeChildOfContent();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        frameLayoutParams = (FrameLayout.LayoutParams) mChildOfContent.getLayoutParams();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">possiblyResizeChildOfContent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> usableHeightNow = computeUsableHeight();</div><div class="line">        <span class="keyword">if</span> (usableHeightNow != usableHeightPrevious) &#123;</div><div class="line">            <span class="keyword">int</span> usableHeightSansKeyboard = mChildOfContent.getRootView().getHeight();</div><div class="line">            <span class="keyword">int</span> heightDifference = usableHeightSansKeyboard - usableHeightNow;</div><div class="line">            <span class="keyword">if</span> (heightDifference &gt; (usableHeightSansKeyboard/<span class="number">4</span>)) &#123;</div><div class="line">                <span class="comment">// keyboard probably just became visible</span></div><div class="line">                frameLayoutParams.height = usableHeightSansKeyboard - heightDifference;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// keyboard probably just became hidden</span></div><div class="line">                frameLayoutParams.height = usableHeightSansKeyboard;</div><div class="line">            &#125;</div><div class="line">            mChildOfContent.requestLayout();</div><div class="line">            usableHeightPrevious = usableHeightNow;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">computeUsableHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">        Rect r = <span class="keyword">new</span> Rect();</div><div class="line">        mChildOfContent.getWindowVisibleDisplayFrame(r);</div><div class="line">        <span class="keyword">return</span> (r.bottom - r.top);<span class="comment">// å…¨å±æ¨¡å¼ä¸‹ï¼š return r.bottom</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»£ç å¤§è‡´æ˜¯åšäº†è¿™ä¹ˆå‡ ä»¶äº‹ï¼š </p>
<h3 id="1-æ‰¾åˆ°activityçš„æ ¹View"><a href="#1-æ‰¾åˆ°activityçš„æ ¹View" class="headerlink" title="1.æ‰¾åˆ°activityçš„æ ¹View"></a>1.æ‰¾åˆ°activityçš„æ ¹View</h3><p>çœ‹ä¸€ä¸‹å…¥å£çš„ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">FrameLayout content = (FrameLayout) activity.findViewById(android.R.id.content);</div><div class="line">mChildOfContent = content.getChildAt(<span class="number">0</span>);</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ï¼Œç¬¬ä¸€è¡Œä¸­çš„<code>android.R.id.content</code>æ‰€æŒ‡çš„Viewï¼Œæ˜¯Androidæ‰€æœ‰Activityç•Œé¢ä¸Šå¼€å‘è€…æ‰€èƒ½æ§åˆ¶çš„åŒºåŸŸçš„æ ¹Viewã€‚</p>
<blockquote>
<ul>
<li>å¦‚æœActivityæ˜¯<code>å…¨å±æ¨¡å¼</code>ï¼Œé‚£ä¹ˆandroid.R.id.contentå°±æ˜¯å æ»¡å…¨éƒ¨å±å¹•åŒºåŸŸçš„ã€‚</li>
<li>å¦‚æœActivityæ˜¯æ™®é€šçš„<code>éå…¨å±æ¨¡å¼</code>ï¼Œé‚£ä¹ˆandroid.R.id.contentå°±æ˜¯å æ»¡é™¤çŠ¶æ€æ ä¹‹å¤–çš„æ‰€æœ‰åŒºåŸŸã€‚</li>
<li>å…¶ä»–æƒ…å†µï¼Œå¦‚Activityæ˜¯å¼¹çª—ã€æˆ–è€…7.0ä»¥åçš„åˆ†å±æ ·å¼ç­‰ï¼Œandroid.R.id.contentä¹Ÿæ˜¯å¼¹çª—çš„èŒƒå›´æˆ–è€…åˆ†å±æ‰€åœ¨çš„åŠä¸ªå±å¹•â€”â€”è¿™äº›æƒ…å†µè¾ƒå°‘ï¼Œå°±æš‚ä¸”ä¸è€ƒè™‘äº†ã€‚</li>
</ul>
</blockquote>
<p>æˆ‘ä»¬ç»å¸¸ç”¨çš„setContentView(View view)/setContent(int layRes)å…¶å®å°±æ˜¯æŠŠæˆ‘ä»¬æŒ‡å®šçš„Viewæˆ–è€…layResæ”¾åˆ°android.R.id.contenté‡Œé¢ï¼Œæˆä¸ºå®ƒçš„å­Viewã€‚</p>
<p>æ‰€ä»¥ï¼Œç„¶åï¼Œç¬¬äºŒè¡Œcontent.getChildAt(0)è·å–åˆ°çš„<code>mChildOfContent</code>ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ç”¨ä»¥è·å–åˆ°æˆ‘ä»¬ç”¨setContentViewæ”¾è¿›å»çš„Viewã€‚</p>
<h3 id="2-è®¾ç½®ä¸€ä¸ªListenerç›‘å¬Viewæ ‘å˜åŒ–"><a href="#2-è®¾ç½®ä¸€ä¸ªListenerç›‘å¬Viewæ ‘å˜åŒ–" class="headerlink" title="2.è®¾ç½®ä¸€ä¸ªListenerç›‘å¬Viewæ ‘å˜åŒ–"></a>2.è®¾ç½®ä¸€ä¸ªListenerç›‘å¬Viewæ ‘å˜åŒ–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mChildOfContent.getViewTreeObserver().addOnGlobalLayoutListener(&#123; <span class="comment">//ç®€åŒ–äº†å†™æ³•</span></div><div class="line">        possiblyResizeChildOfContent();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>View.getViewTreeObserver()å¯ä»¥è·å–ä¸€ä¸ª<code>ViewTreeObserver</code>å¯¹è±¡â€”â€”è¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œä¸“é—¨ç”¨ä»¥ç›‘å¬å½“å‰Viewæ ‘æ‰€å‘ç”Ÿçš„ä¸€äº›å˜åŒ–ã€‚è¿™é‡Œæ‰€æ³¨å†Œçš„<code>addOnGlobalLayoutListener</code>ï¼Œå°±æ˜¯ä¼šåœ¨å½“å‰çš„Viewæ ‘çš„å…¨å±€å¸ƒå±€ï¼ˆGlobalLayoutï¼‰å‘ç”Ÿå˜åŒ–ã€æˆ–è€…å…¶ä¸­çš„Viewå¯è§†çŠ¶æ€æœ‰å˜åŒ–æ—¶ï¼Œè¿›è¡Œé€šçŸ¥å›è°ƒã€‚</p>
<p>â€”â€”<strong>ã€è½¯é”®ç›˜å¼¹å‡ºã€ï¼Œåˆ™æ˜¯ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶çš„ä¸€ä¸ªæºã€‚</strong> (è½¯é”®ç›˜å¼¹å‡ºä¼šä½¿GlobalLayoutå‘ç”Ÿå˜åŒ–)</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨èƒ½ç›‘å¬åˆ°ã€è½¯é”®ç›˜å¼¹å‡ºã€çš„äº‹ä»¶äº†ã€‚ </p>
<h3 id="3-ç•Œé¢å˜åŒ–ä¹‹åï¼Œè·å–â€å¯ç”¨é«˜åº¦â€"><a href="#3-ç•Œé¢å˜åŒ–ä¹‹åï¼Œè·å–â€å¯ç”¨é«˜åº¦â€" class="headerlink" title="3.ç•Œé¢å˜åŒ–ä¹‹åï¼Œè·å–â€å¯ç”¨é«˜åº¦â€"></a>3.ç•Œé¢å˜åŒ–ä¹‹åï¼Œè·å–â€å¯ç”¨é«˜åº¦â€</h3><p>å½“è½¯é”®ç›˜å¼¹å‡ºäº†ä¹‹åï¼Œæ¥ä¸‹æ¥çš„äº‹æƒ…æ˜¯è·å–æ”¹å˜ä¹‹åçš„ç•Œé¢çš„<code>å¯ç”¨é«˜åº¦</code>ï¼ˆå¯ä»¥è¢«å¼€å‘è€…ç”¨ä»¥æ˜¾ç¤ºå†…å®¹çš„é«˜åº¦ï¼‰ã€‚<br>ç›´æ¥çœ‹ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">computeUsableHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">    Rect rect = <span class="keyword">new</span> Rect();</div><div class="line">    mChildOfContent.getWindowVisibleDisplayFrame(rect);</div><div class="line">    <span class="comment">// rect.topå…¶å®æ˜¯çŠ¶æ€æ çš„é«˜åº¦ï¼Œå¦‚æœæ˜¯å…¨å±ä¸»é¢˜ï¼Œç›´æ¥ return rect.bottomå°±å¯ä»¥äº†</span></div><div class="line">    <span class="keyword">return</span> (rect.bottom - rect.top);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>View.getWindowVisibleDisplayFrame(Rect rect)ï¼Œè¿™è¡Œä»£ç èƒ½å¤Ÿè·å–åˆ°çš„Rectâ€”â€”å°±æ˜¯ç•Œé¢é™¤å»äº†æ ‡é¢˜æ ã€é™¤å»äº†è¢«è½¯é”®ç›˜æŒ¡ä½çš„éƒ¨åˆ†ï¼Œæ‰€å‰©ä¸‹çš„çŸ©å½¢åŒºåŸŸâ€”â€”å¦‚å›¾æ‰€ç¤ºï¼Œçº¢æ¡†ä¸­çš„åŒºåŸŸã€‚<br><img src="http://barryzhang.qiniudn.com/QQ20161025.jpg" alt="RectåŒºåŸŸç¤ºæ„å›¾"></p>
<p>â†‘ä¹Ÿå¯ä»¥çœ‹å‡ºï¼š</p>
<ul>
<li>rect.topå€¼ï¼Œå…¶å®å°±æ˜¯æ ‡é¢˜æ çš„é«˜åº¦ã€‚ï¼ˆå®é™…ä¸Šï¼Œè¿™ä¹Ÿå¸¸å¸¸è¢«ç”¨ä½œä¸ºè·å–æ ‡é¢˜æ é«˜åº¦çš„æ–¹æ³•ï¼‰</li>
<li>å±å¹•é«˜åº¦-rect.bottomï¼Œæ˜¯è½¯é”®ç›˜çš„é«˜åº¦ã€‚ï¼ˆè·å–è½¯é”®ç›˜é«˜åº¦çš„æ–¹æ³•ä¹Ÿå‡ºç°äº†ï¼‰</li>
</ul>
<p>è¿™æ—¶ï¼Œå°±æœ‰ï¼š</p>
<ul>
<li><code>å…¨å±æ¨¡å¼</code>ä¸‹ï¼Œ<code>å¯ç”¨é«˜åº¦</code> = rect.bottom </li>
<li>é<code>å…¨å±æ¨¡å¼</code>ï¼Œ<code>å¯ç”¨é«˜åº¦</code> = rect.bottom - rect.top</li>
</ul>
<h3 id="4-æœ€åä¸€æ­¥ï¼Œé‡è®¾é«˜åº¦"><a href="#4-æœ€åä¸€æ­¥ï¼Œé‡è®¾é«˜åº¦" class="headerlink" title="4.æœ€åä¸€æ­¥ï¼Œé‡è®¾é«˜åº¦"></a>4.æœ€åä¸€æ­¥ï¼Œé‡è®¾é«˜åº¦</h3><p>æˆ‘ä»¬è®¡ç®—å‡ºçš„<code>å¯ç”¨é«˜åº¦</code>ï¼Œæ˜¯ç›®å‰åœ¨è§†è§‰æ•ˆæœä¸Šèƒ½çœ‹åˆ°çš„ç•Œé¢é«˜åº¦ã€‚ä½†å½“å‰ç•Œé¢çš„å®é™…é«˜åº¦æ˜¯æ¯”<code>å¯ç”¨é«˜åº¦</code>è¦å¤šå‡ºä¸€ä¸ªè½¯é”®ç›˜çš„è·ç¦»çš„ã€‚<br>æ‰€ä»¥ï¼Œæœ€åä¸€æ­¥ï¼Œå°±æ˜¯æŠŠç•Œé¢é«˜åº¦ç½®ä¸º<code>å¯ç”¨é«˜åº¦</code>â€”â€”å¤§åŠŸå‘Šæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">possiblyResizeChildOfContent</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> usableHeightNow = computeUsableHeight();</div><div class="line">    <span class="keyword">if</span> (usableHeightNow != usableHeightPrevious) &#123;</div><div class="line">        <span class="keyword">int</span> usableHeightSansKeyboard = mChildOfContent.getRootView().getHeight();</div><div class="line">        <span class="keyword">int</span> heightDifference = usableHeightSansKeyboard - usableHeightNow;</div><div class="line">        <span class="keyword">if</span> (heightDifference &gt; (usableHeightSansKeyboard/<span class="number">4</span>)) &#123;</div><div class="line">            <span class="comment">// keyboard probably just became visible</span></div><div class="line">            frameLayoutParams.height = usableHeightSansKeyboard - heightDifference;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// keyboard probably just became hidden</span></div><div class="line">            frameLayoutParams.height = usableHeightSansKeyboard;</div><div class="line">        &#125;</div><div class="line">        mChildOfContent.requestLayout();</div><div class="line">        usableHeightPrevious = usableHeightNow;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç é‡Œæ·»åŠ äº†ä¸€ä¸ªâ€heightDifference &gt; (usableHeightSansKeyboard/4)â€çš„åˆ¤æ–­ï¼Œè¿™æ˜¯ä¸ºäº†å»é™¤æ— è°“çš„å¹²æ‰°ã€‚å› ä¸ºèƒ½è§¦å‘OnGlobalLayoutäº‹ä»¶çš„åŸå› æœ‰å¾ˆå¤šï¼Œä¸æ­¢æ˜¯è½¯é”®ç›˜çš„å¼¹å‡ºå˜åŒ–ï¼Œè¿˜åŒ…æ‹¬å„ç§å­Viewçš„éšè—æ˜¾ç¤ºå˜åŒ–ç­‰ï¼Œå®ƒä»¬å¯¹ç•Œé¢é«˜åº¦çš„å½±å“æœ‰é™ã€‚åŠ ä¸Šäº†è¿™ä¸ªåˆ¤æ–­ä¹‹åï¼Œåªæœ‰ç•Œé¢çš„é«˜åº¦å˜åŒ–è¶…è¿‡1/4çš„å±å¹•é«˜åº¦ï¼Œæ‰ä¼šè¿›è¡Œé‡æ–°è®¾ç½®é«˜åº¦ï¼ŒåŸºæœ¬èƒ½ä¿è¯ä»£ç åªå“åº”è½¯é”®ç›˜çš„å¼¹å‡ºã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ€»ç»“èµ·æ¥ï¼Œå°±æ˜¯è¿™æ ·ï¼š</p>
<ol>
<li>æ™®é€šActivityï¼ˆä¸å¸¦WebViewï¼‰ï¼Œç›´æ¥ä½¿ç”¨<code>adjustpan</code>æˆ–è€…<code>adjustResize</code></li>
<li>å¦‚æœå¸¦WebViewï¼š   <ul>
<li>a) å¦‚æœé<code>å…¨å±æ¨¡å¼</code>ï¼Œå¯ä»¥ä½¿ç”¨<code>adjustResize</code></li>
<li>b) å¦‚æœæ˜¯<code>å…¨å±æ¨¡å¼</code>ï¼Œåˆ™ä½¿ç”¨<code>AndroidBug5497Workaround</code>è¿›è¡Œå¤„ç†ã€‚</li>
</ul>
</li>
</ol>
<p>OKï¼Œä»¥ä¸Šå°±æ˜¯ä¸€æ®µå…³äºã€è½¯é”®ç›˜æŒ¡ä½è¾“å…¥æ¡†ã€çš„çˆ¬å‘ä¹‹æ—…ã€‚</p>
<h1 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h1><p>æœ‰ç”¨çš„é“¾æ¥ï¼š<br><a href="https://code.google.com/p/android/issues/detail?id=5497" target="_blank" rel="external">https://code.google.com/p/android/issues/detail?id=5497</a><br><a href="http://stackoverflow.com/a/19494006" target="_blank" rel="external">http://stackoverflow.com/a/19494006</a><br><a href="https://developer.android.com/reference/android/view/ViewTreeObserver.html" target="_blank" rel="external">https://developer.android.com/reference/android/view/ViewTreeObserver.html</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/11/19/difference-of-startactivityforresult-bettwen-fragment-activity/" class="prev">ä¸Šä¸€ç¯‡</a><a href="/2016/10/21/why-we-need-kotlin/" class="next">ä¸‹ä¸€ç¯‡</a></div><div class="copyright"><p>Â© 2015 - 2017 <a href="http://barryhappy.github.io">Barry Zhang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>